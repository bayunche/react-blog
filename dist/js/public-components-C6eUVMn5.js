import{a6 as e,f as s,F as a,r as t,a7 as l,j as r,I as i,a8 as n,a9 as o,B as c,aa as d,ab as u,ac as m,ad as p,H as g,O as h,ae as f,G as x,af as b,ag as j,T as y,C,u as w,ah as v,ai as k,aj as N,ak as S,X as F,N as L,al as _,am as P}from"./react-vendor-DCjvIuTI.js";import{s as z,u as I,G,a as T,b as M,g as R,A as U,c as B,d as A}from"./admin-B2Kg6n_K.js";const E=e.enc.Utf8.parse("1234567890000000"),O=e.enc.Utf8.parse("1234567890000000"),H={encrypt(s){let a="";if("string"==typeof s){const t=e.enc.Utf8.parse(s);a=e.AES.encrypt(t,E,{iv:O,mode:e.mode.CBC,padding:e.pad.Pkcs7})}else if("object"==typeof s){const t=JSON.stringify(s),l=e.enc.Utf8.parse(t);a=e.AES.encrypt(l,E,{iv:O,mode:e.mode.CBC,padding:e.pad.Pkcs7})}return a.ciphertext.toString()},decrypt(s){const a=e.enc.Hex.parse(s),t=e.enc.Base64.stringify(a);return e.AES.decrypt(t,E,{iv:O,mode:e.mode.CBC,padding:e.pad.Pkcs7}).toString(e.enc.Utf8).toString()}},q=e=>{const s={isValid:!1,message:"",score:0};if(!e)return s.message="密码不能为空",s;const a=/[A-Z]/.test(e),t=/[a-z]/.test(e),l=/\d/.test(e),r=/[!@#$%^&*(),.?":{}|<>]/.test(e);let i=0;if(e.length>=8&&(i+=20),e.length>=12&&(i+=10),a&&(i+=20),t&&(i+=20),l&&(i+=20),r&&(i+=20),s.score=i,e.length<8)return s.message="密码长度至少需要".concat(8,"位"),s;if(!a||!t||!l)return s.message="密码必须包含大写字母、小写字母和数字",s;if(["12345678","123456789","password","qwerty123","abc123456","11111111","00000000"].includes(e.toLowerCase()))return s.message="不能使用常见的弱密码",s;return/(.)\1{2,}/.test(e)?(s.message="密码不能包含连续重复的字符",s):(s.isValid=!0,s.message=i>=80?"密码强度：强":i>=60?"密码强度：中等":"密码强度：弱，建议添加特殊字符",s)},V=Object.freeze(Object.defineProperty({__proto__:null,default:H,validatePassword:q},Symbol.toStringTag,{value:"Module"})),D=({onSuccess:e,onClose:l}={})=>{const[r]=a.useForm(),[i,n]=t.useState(!1),{loginSuccess:o,setLoading:c,setError:d,clearError:u}=I(),m=t.useCallback(()=>{r.resetFields(),u()},[r,u]),p=t.useCallback((e,s)=>new Promise((e,a)=>{s&&s!==r.getFieldValue("password")?a(new Error("两次输入的密码不一致！")):e()}),[r]),g=t.useCallback(async a=>{var t,r;try{n(!0),c(!0),u();const t=await(async e=>{void 0!==e.password&&(e.password=H.encrypt(e.password));try{const a=await z.post("/login",e);return s.success("登录成功, 欢迎您 ".concat(a.username)),a}catch(a){throw s.error(a.message||"登录失败"),a}})(a);o(t),s.success("登录成功！"),null==e||e(t,"login"),null==l||l()}catch(i){const e=(null==(r=null==(t=i.response)?void 0:t.data)?void 0:r.message)||i.message||"登录失败，请检查用户名和密码";d(e),s.error(e)}finally{n(!1),c(!1)}},[o,c,d,u,e,l]),h=t.useCallback(async a=>{var t,l;try{n(!0),c(!0),u();const t=q(a.password);if(!t.isValid)return d(t.message),void s.error(t.message);if(a.password!==a.confirm){const e="两次输入的密码不一致";return d(e),void s.error(e)}const l=await(async e=>{void 0!==e.password&&(e.password=H.encrypt(e.password));try{const a=await z.post("/register",e);return s.success("注册成功，请重新登录您的账号！"),a}catch(a){throw s.error(a.message||"注册失败"),a}})({username:a.username,password:a.password,email:a.email});s.success("注册成功！请使用新账号登录。"),null==e||e(l,"register"),m()}catch(r){const e=(null==(l=null==(t=r.response)?void 0:t.data)?void 0:l.message)||r.message||"注册失败，请重试";d(e),s.error(e)}finally{n(!1),c(!1)}},[c,d,u,e,m]),f=t.useCallback(async e=>{try{const s=await r.validateFields();"login"===e?await g(s):"register"===e&&await h(s)}catch(a){a.errorFields&&s.warning("请检查表单填写是否完整和正确")}},[r,g,h]),x=t.useCallback(()=>({login:{account:[{required:!0,message:"请输入用户名"},{min:2,message:"用户名至少2个字符"},{max:20,message:"用户名最多20个字符"}],password:[{required:!0,message:"请输入密码"},{min:6,message:"密码至少6个字符"}]},register:{username:[{required:!0,message:"请输入用户名"},{min:2,message:"用户名至少2个字符"},{max:20,message:"用户名最多20个字符"},{pattern:/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/,message:"用户名只能包含字母、数字、下划线和中文"}],password:[{required:!0,message:"请输入密码"},{min:8,message:"密码至少8个字符"},{validator:(e,s)=>{if(!s)return Promise.resolve();const a=q(s);return a.isValid?Promise.resolve():Promise.reject(new Error(a.message))}}],confirm:[{required:!0,message:"请确认密码"},{validator:p}],email:[{required:!0,message:"请输入邮箱地址"},{type:"email",message:"请输入有效的邮箱地址"}]}}),[p]),b=t.useCallback(()=>({labelCol:{xs:{span:24},sm:{span:6}},wrapperCol:{xs:{span:24},sm:{span:18}}}),[]);return{form:r,submitting:i,handleSubmit:f,resetForm:m,getFormRules:x,getFormLayout:b}},K=({form:e,formLayout:s,formRules:t,submitting:l=!1,onSubmit:d,className:u=""})=>r.jsxs("div",{className:"login-form ".concat(u),children:[r.jsxs("div",{className:"login-form__header",children:[r.jsx("h3",{className:"form-title",children:"用户登录"}),r.jsx("p",{className:"form-description",children:"请输入您的登录凭据"})]}),r.jsxs(a,{form:e,layout:"horizontal",...s,onFinish:d,className:"login-form__form",children:[r.jsx(a.Item,{label:"用户名",name:"account",rules:t.account,children:r.jsx(i,{prefix:r.jsx(n,{className:"input-icon"}),placeholder:"请输入用户名",size:"large",className:"form-input"})}),r.jsx(a.Item,{label:"密码",name:"password",rules:t.password,children:r.jsx(i.Password,{prefix:r.jsx(o,{className:"input-icon"}),placeholder:"请输入密码",size:"large",className:"form-input"})}),r.jsx(a.Item,{wrapperCol:{offset:s.labelCol.sm.span,span:s.wrapperCol.sm.span},children:r.jsx(c,{type:"primary",htmlType:"submit",loading:l,size:"large",block:!0,className:"submit-btn",children:l?"登录中...":"登录"})})]}),r.jsx("div",{className:"login-form__footer",children:r.jsxs("p",{className:"footer-text",children:["还没有账号？",r.jsx(c,{type:"link",size:"small",className:"switch-link",children:"立即注册"})]})})]}),Z=({form:e,formLayout:s,formRules:t,submitting:l=!1,onSubmit:m,className:p=""})=>r.jsxs("div",{className:"register-form ".concat(p),children:[r.jsxs("div",{className:"register-form__header",children:[r.jsx("h3",{className:"form-title",children:"用户注册"}),r.jsx("p",{className:"form-description",children:"创建您的新账号"})]}),r.jsxs(a,{form:e,layout:"horizontal",...s,onFinish:m,className:"register-form__form",children:[r.jsx(a.Item,{label:"用户名",name:"username",rules:t.username,hasFeedback:!0,children:r.jsx(i,{prefix:r.jsx(n,{className:"input-icon"}),placeholder:"请输入用户名（2-20个字符）",size:"large",className:"form-input"})}),r.jsx(a.Item,{label:"密码",name:"password",rules:t.password,hasFeedback:!0,children:r.jsx(i.Password,{prefix:r.jsx(o,{className:"input-icon"}),placeholder:"请输入密码（至少8位，包含字母和数字）",size:"large",className:"form-input"})}),r.jsx(a.Item,{label:"确认密码",name:"confirm",rules:t.confirm,hasFeedback:!0,children:r.jsx(i.Password,{prefix:r.jsx(d,{className:"input-icon"}),placeholder:"请再次输入密码",size:"large",className:"form-input"})}),r.jsx(a.Item,{label:"邮箱",name:"email",rules:t.email,hasFeedback:!0,children:r.jsx(i,{prefix:r.jsx(u,{className:"input-icon"}),placeholder:"请输入邮箱地址",size:"large",className:"form-input"})}),r.jsx(a.Item,{wrapperCol:{offset:s.labelCol.sm.span,span:s.wrapperCol.sm.span},children:r.jsx(c,{type:"primary",htmlType:"submit",loading:l,size:"large",block:!0,className:"submit-btn",children:l?"注册中...":"注册"})})]}),r.jsxs("div",{className:"register-form__footer",children:[r.jsxs("div",{className:"password-tips",children:[r.jsx("h4",{children:"密码要求："}),r.jsxs("ul",{children:[r.jsx("li",{children:"至少8个字符"}),r.jsx("li",{children:"包含大小写字母"}),r.jsx("li",{children:"包含数字"}),r.jsx("li",{children:"可包含特殊字符"})]})]}),r.jsxs("p",{className:"footer-text",children:["已有账号？",r.jsx(c,{type:"link",size:"small",className:"switch-link",children:"立即登录"})]})]})]}),$=({available:e=!1,loading:s=!1,onGithubLogin:a,className:t=""})=>e?r.jsxs("div",{className:"social-auth ".concat(t),children:[r.jsx(m,{className:"divider",children:r.jsx("span",{className:"divider-text",children:"或"})}),r.jsxs("div",{className:"social-auth__content",children:[r.jsx(c,{block:!0,size:"large",icon:r.jsx(p,{}),onClick:a,loading:s,className:"github-btn",children:s?"GitHub 登录中...":"使用 GitHub 登录"}),r.jsx("p",{className:"social-auth__tips",children:"使用 GitHub 登录将自动创建账号"})]})]}):null,{TabPane:J}=f,W=()=>{const[e,a]=t.useState(!1),[i,n]=t.useState("login"),[o,c]=t.useState(""),{handleGithubLogin:d,getGithubButtonConfig:u}=(()=>{const e=l(),a=t.useCallback(()=>!1,[]),r=t.useCallback((e={})=>{if(!a())throw new Error("GitHub登录未配置或不可用");const{state:s="",redirectUri:t=""}=e,l=G.url,r=G.client_id,n=new URLSearchParams({client_id:r,scope:"user:email",state:s||i()});return t&&n.append("redirect_uri",t),"".concat(l,"?").concat(n.toString())},[a]),i=t.useCallback(()=>Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),[]),n=t.useCallback(()=>{const{pathname:s,search:a}=e,t="".concat(s).concat(a);T("prevRouter",t),T("githubAuthTime",Date.now())},[e]),c=t.useCallback((e={})=>{const{onBeforeRedirect:t,onError:l}=e;try{if(!a()){const e="GitHub登录功能未启用或配置不完整";return s.error(e),void(null==l||l(new Error(e)))}n();const e=r();null==t||t(),window.location.href=e}catch(o){s.error(o.message||"GitHub登录失败"),null==l||l(o)}},[a,n,r]),d=t.useCallback(async(e,s)=>{try{return{code:e,state:s,timestamp:Date.now()}}catch(o){throw o}},[]),u=t.useCallback(()=>({available:a(),text:"GitHub 登录",icon:"GithubOutlined",type:"default",block:!0,style:{marginTop:12,borderColor:"#24292e",color:"#24292e"},disabled:!a()}),[a]),m=t.useCallback(()=>{localStorage.removeItem("prevRouter"),localStorage.removeItem("githubAuthTime")},[]);return{isGithubAuthAvailable:a,handleGithubLogin:c,handleGithubCallback:d,getGithubButtonConfig:u,generateAuthUrl:r,saveCurrentRoute:n,clearAuthStorage:m}})(),{form:m,submitting:p,handleSubmit:x,resetForm:b,getFormRules:j,getFormLayout:y}=D({onSuccess:(e,s)=>{a(!1),"register"===s&&(n("login"),b())},onClose:()=>{a(!1)}});M("openSignModal",e=>{b(),c(""),n(e||"login"),a(!0)});const C=t.useCallback(()=>{a(!1),c(""),b()},[b]),w=t.useCallback(e=>{n(e),c(""),b()},[b]),v=t.useCallback(async()=>{try{await x(i)}catch(e){}},[x,i]),k=t.useCallback(()=>{d({onBeforeRedirect:()=>{a(!1)},onError:e=>{c(e.message)}})},[d]),N=y(),S=j(),F=u();return r.jsx(g,{title:null,open:e,onCancel:C,footer:null,width:480,centered:!0,className:"sign-modal",destroyOnClose:!0,children:r.jsxs("div",{className:"sign-modal__content",children:[o&&r.jsx(h,{message:"操作失败",description:o,type:"error",showIcon:!0,closable:!0,onClose:()=>c(""),className:"error-alert"}),r.jsxs(f,{activeKey:i,onChange:w,centered:!0,className:"auth-tabs",children:[r.jsx(J,{tab:"登录",children:r.jsx(K,{form:m,formLayout:N,formRules:S.login,submitting:p,onSubmit:v})},"login"),r.jsx(J,{tab:"注册",children:r.jsx(Z,{form:m,formLayout:N,formRules:S.register,submitting:p,onSubmit:v})},"register")]}),r.jsx($,{available:F.available,loading:p,onGithubLogin:k})]})})};function X(e=!1){const[s,a]=t.useState(e),l=t.useCallback(()=>a(!0),[s]),r=t.useCallback(()=>a(!1),[s]),i=t.useCallback(()=>{"boolean"==typeof s&&a(s)},[s]);return{value:s,setTrue:l,setFalse:r,toggle:i}}const{Dragger:Q}=b,Y=({uploadConfig:e})=>r.jsxs(Q,{...e,className:"upload-dragger",children:[r.jsx("p",{className:"ant-upload-drag-icon",children:r.jsx(j,{})}),r.jsx("p",{className:"ant-upload-text",children:"点击或拖拽文件到此区域上传"}),r.jsx("p",{className:"ant-upload-hint",children:"支持单个或批量上传，仅支持 Markdown (.md) 格式文件，单个文件不超过 10MB"})]}),ee=({fileList:e,getParsedFile:s,onRemoveFile:a})=>{const l=t.useMemo(()=>[{dataIndex:"name",title:"文件名",ellipsis:!0,render:e=>r.jsx("span",{title:e,className:"file-name",children:e})},{dataIndex:"title",title:"文章标题",ellipsis:!0,render:(e,a)=>{const t=s(a.name);return r.jsx("span",{title:t.title,className:"article-title",children:t.title||"解析中..."})}},{dataIndex:"status",title:"状态",width:100,render:(e,a)=>{if("error"===e)return r.jsx(y,{color:"red",children:"上传失败"});if("uploading"===e)return r.jsx(y,{color:"blue",children:"上传中"});if("done"===e){return s(a.name).exist?r.jsx(y,{color:"gold",children:"更新"}):r.jsx(y,{color:"green",children:"新增"})}return r.jsx(y,{color:"default",children:"等待中"})}},{dataIndex:"uid",title:"操作",width:80,render:(e,s)=>r.jsx(c,{type:"text",size:"small",danger:!0,icon:r.jsx(C,{}),onClick:()=>a(e),className:"remove-btn",children:"删除"})}],[s,a]);return r.jsx("div",{className:"upload-table",children:r.jsx(w,{dataSource:e,columns:l,rowKey:"uid",pagination:!1,size:"small",className:"upload-files-table",locale:{emptyText:"暂无文件"}})})},se=({fileList:e,getParsedFile:s})=>{const a=t.useMemo(()=>{const a={total:e.length,success:0,failed:0,newFiles:0,updateFiles:0};return e.forEach(e=>{if("done"===e.status){a.success++;const t=s(e.name);t.exist?a.updateFiles++:t.title&&a.newFiles++}else"error"===e.status&&a.failed++}),a},[e,s]);return 0===e.length?null:r.jsx(v,{className:"upload-summary",size:"small",children:r.jsxs(k,{gutter:16,justify:"center",children:[r.jsx(N,{span:6,children:r.jsx(S,{title:"总文件",value:a.total,prefix:r.jsx(F,{}),valueStyle:{color:"#1890ff"}})}),r.jsx(N,{span:6,children:r.jsx(S,{title:"新增",value:a.newFiles,prefix:r.jsx(L,{}),valueStyle:{color:"#52c41a"}})}),r.jsx(N,{span:6,children:r.jsx(S,{title:"更新",value:a.updateFiles,prefix:r.jsx(_,{}),valueStyle:{color:"#faad14"}})}),r.jsx(N,{span:6,children:r.jsx(S,{title:"失败",value:a.failed,prefix:r.jsx(P,{}),valueStyle:{color:"#ff4d4f"}})})]})})},ae=()=>{const{fileList:e,getParsedFile:a,removeFile:l,resetFiles:i,getUploadConfig:n,getUploadList:o}=(()=>{const[e,a]=t.useState([]),[l,r]=t.useState([]),i=t.useRef(null),n=t.useCallback(e=>l.find(s=>s.fileName===e)||{},[l]),o=t.useCallback(({file:e,fileList:t})=>{"done"===e.status&&(clearTimeout(i.current),i.current=setTimeout(()=>{const e=t.map(e=>e.name);e.length>0&&z.post("/article/checkExist",{fileNameList:e}).then(e=>{r(e)}).catch(e=>{s.error("检查文件状态失败")})},1e3)),a(t)},[]),c=t.useCallback(s=>{const t=e.findIndex(e=>e.uid===s);if(t>-1){const s=[...e];s.splice(t,1),a(s)}},[e]),d=t.useCallback(()=>{a([]),r([]),clearTimeout(i.current)},[]),u=t.useCallback(()=>({name:"file",multiple:!0,showUploadList:!1,action:"".concat(U,"/article/upload"),onChange:o,headers:{Authorization:R()},accept:"text/markdown",beforeUpload:e=>"text/markdown"===e.type||e.name.endsWith(".md")?!!(e.size/1024/1024<10)||(s.error("文件大小不能超过 10MB!"),!1):(s.error("只能上传 Markdown 文件!"),!1)}),[o]),m=t.useCallback(()=>e.reduce((e,s)=>{if("done"===s.status){const a=l.find(e=>s.name===e.fileName);a&&e.push(a)}return e},[]),[e,l]);return{fileList:e,parsedList:l,getParsedFile:n,handleFileChange:o,removeFile:c,resetFiles:d,getUploadConfig:u,getUploadList:m}})(),{handleSubmit:c,getSubmitButtonProps:d}=(()=>{const e=I(e=>{var s;return null==(s=e.user)?void 0:s.userId}),s=X(!1),a=t.useCallback(async(a,t,l)=>{var r,i;if(a&&0!==a.length)try{s.setTrue();const l=await z.post("/article/upload/confirm",{authorId:e,uploadList:a});x.success({message:"上传成功",description:"插入文章数: ".concat(l.insertList.length,"，更新文章数: ").concat(l.updateList.length),duration:4.5}),"function"==typeof t&&t(l)}catch(n){const e=(null==(i=null==(r=n.response)?void 0:r.data)?void 0:i.message)||n.message||"上传失败，请重试";x.error({message:"上传失败",description:e,duration:6}),"function"==typeof l&&l(n)}finally{s.setFalse()}else x.warning({message:"提示",description:"请选择要上传的文件"})},[e,s]),l=t.useCallback((e=0)=>({loading:s.value,disabled:0===e,type:"primary"}),[s.value]);return{confirmLoading:s.value,handleSubmit:a,getSubmitButtonProps:l}})(),{closeModal:u,getModalConfig:m}=(({onOpen:e,onClose:s}={})=>{const{value:a,setTrue:l,setFalse:r}=X(!1),i=t.useCallback(()=>{l(),"function"==typeof e&&e()},[l,e]),n=t.useCallback(()=>{r(),"function"==typeof s&&s()},[r,s]);M("openUploadModal",i);const o=t.useCallback(()=>({width:760,open:a,title:"导入文章",onCancel:n,maskClosable:!1,destroyOnClose:!0,centered:!0,className:"upload-modal"}),[a,n]);return{visible:a,openModal:i,closeModal:n,getModalConfig:o}})({onOpen:i,onClose:i}),p=n(),h=m(),f=d(e.length);return r.jsxs(g,{...h,onOk:async()=>{const e=o();await c(e,u)},okButtonProps:f,okText:"确认导入",cancelText:"取消",children:[r.jsx(Y,{uploadConfig:p}),r.jsx(se,{fileList:e,getParsedFile:a}),e.length>0&&r.jsx(ee,{fileList:e,getParsedFile:a,onRemoveFile:l})]})};function te(e){const s=B(e=>e.fetchTagList),a=B(e=>e.fetchCategoryList);return A(()=>{s(),a()}),r.jsxs(r.Fragment,{children:[r.jsx(W,{}),r.jsx(ae,{})]})}export{te as P,V as p};
